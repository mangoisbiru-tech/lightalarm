name: Backup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]

jobs:
  create-backup:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Create project snapshot
      run: |
        # Create backup directory with timestamp
        BACKUP_DIR="backup-$(date +%Y%m%d-%H%M%S)"
        mkdir -p $BACKUP_DIR

        # Copy source files
        cp -r src $BACKUP_DIR/
        cp package.json $BACKUP_DIR/
        cp README.md $BACKUP_DIR/
        cp -r memory-bank $BACKUP_DIR/

        # Create archive info
        echo "Project: Light Alarm App" > $BACKUP_DIR/info.txt
        echo "Date: $(date)" >> $BACKUP_DIR/info.txt
        echo "Branch: ${{ github.ref }}" >> $BACKUP_DIR/info.txt
        echo "Commit: ${{ github.sha }}" >> $BACKUP_DIR/info.txt

    - name: Upload backup artifact
      uses: actions/upload-artifact@v3
      with:
        name: project-backup-${{ github.run_number }}
        path: backup-*
        retention-days: 90

    - name: Check backup size
      run: |
        BACKUP_SIZE=$(du -sh backup-* | cut -f1)
        echo "ðŸ“¦ Backup size: $BACKUP_SIZE"

        # Warn if backup is too large (>50MB)
        if [ $(du -s backup-* | cut -f1) -gt 52428800 ]; then
          echo "âš ï¸ Backup size is large (>50MB). Consider cleaning up."
        fi


